name: Build RingRTC AAR
run-name: Build RingRTC AAR (${{ github.ref_name }})

on:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  NDK_VERSION: '25.2.9519653'

jobs:
  build_android:
    name: Build Android

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - run: rustup toolchain install $(cat rust-toolchain) --profile minimal --target aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

    - name: Install protoc
      run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

    - name: set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 17

    - run: ./bin/fetch-artifact --platform android --release

    - run: ANDROID_NDK_HOME="$ANDROID_HOME/ndk/$NDK_VERSION" ./bin/build-aar --ringrtc-only --release

    - name: Publish artifact
      uses: actions/upload-artifact@v3
      with:
        name: android-artifacts
        path: /home/runner/work/ringrtc/ringrtc/out/**/*.aar
